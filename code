/*
 * Arduino Security and Alarm System
 *
 * by Dejan Nedelkovski,
 * www.HowToMechatronics.com
 *
 */

#include <LiquidCrystal.h> // includes the LiquidCrystal Library
#include <Keypad.h>

#define buzzer 4
#define trigPin 3
#define echoPin 2

int initialDistance, currentDistance, i;
int screenOffMsg = 0;
String password = "1234";
String tempPassword;
boolean passChangeMode = false;
boolean passChanged = false;
boolean passTrue = false;

const byte ROWS = 4; // four rows
const byte COLS = 4; // four columns
char keypressed;
// define the cymbols on the buttons of the keypads
char keyMap[ROWS][COLS] = {
				{'1', '2', '3', 'A'},
				{'4', '5', '6', 'B'},
				{'7', '8', '9', 'C'},
				{'*', '0', '#', 'D'}};
byte rowPins[ROWS] = {8, 7, 6, 5};					// Row pinouts of the keypad
byte colPins[COLS] = {A3, A2, A1, A0}; // Column pinouts of the keypad

Keypad myKeypad = Keypad(makeKeymap(keyMap), rowPins, colPins, ROWS, COLS);
LiquidCrystal lcd(0, 1, 9, 10, 11, 12); // Creates an LC object. Parameters: (rs, enable, d4, d5, d6, d7)

void setup()
{
 lcd.begin(16, 2);
 pinMode(buzzer, OUTPUT);		// Set buzzer as an output
 pinMode(trigPin, OUTPUT); // Sets the trigPin as an Output
 pinMode(echoPin, INPUT);		// Sets the echoPin as an Input
}

void loop()
{
 // Bắt đầu chương trình
 lcd.clear();
 lcd.setCursor(0, 0);
 lcd.print("A - Activate");
 lcd.setCursor(0, 1);
 lcd.print("B - Change Pass");
 screenOffMsg = 1;
 keypressed = myKeypad.getKey();
 // khóa
 if (keypressed == 'A')
 {
		while (true)
		{
			beginLock();
			currentDistance = getDistance() + 10;
			if (currentDistance < initialDistance)
			{
				// nhập mật khẩu
				inputPass()
			}
			if (passTrue == true)
			{ // mật khẩu đúng quay về đầu vòng loop
				lcd.setCursor(0, 0);
				lcd.print("Password Correct");
				break;
			}
			else
			{ // mật khẩu sai -> khóa sau 10s
				lcd.setCursor(0, 0);
				lcd.print("Password InCorrect");
				for (int i = 0; i < 10; i++)
				{
					tone(buzzer, 700, 100);
					delay(1000);
				}
				continue;
			}
		}
 }
 if (keypressed == 'B')
 //đổi mật khẩu
 {
		changePass();
 }
}
void changePass()
{
 lcd.clear();
 c int i = 1;
 tone(buzzer, 2000, 100);
 tempPassword = "";
 lcd.setCursor(0, 0);
 lcd.print("Current Password");
 lcd.setCursor(0, 1);
 lcd.print(">");
 passChangeMode = true;
 passChanged = true;
 while (passChanged)
 {
		keypressed = myKeypad.getKey();
		if (keypressed != NO_KEY)
		{
			if (keypressed == '0' || keypressed == '1' || keypressed == '2' || keypressed == '3' ||
							keypressed == '4' || keypressed == '5' || keypressed == '6' || keypressed == '7' ||
							keypressed == '8' || keypressed == '9')
			{
				tempPassword += keypressed;
				lcd.setCursor(i, 1);
				lcd.print("*");
				i++;
				tone(buzzer, 2000, 100);
			}
		}
		if (i > 5 || keypressed == '#')
		{
			tempPassword = "";
			i = 1;
			lcd.clear();
			lcd.setCursor(0, 0);
			lcd.print("Current Password");
			lcd.setCursor(0, 1);
			lcd.print(">");
		}
		if (keypressed == '*')
		{
			i = 1;
			tone(buzzer, 2000, 100);
			if (password == tempPassword)
			{
				tempPassword = "";
				lcd.clear();
				lcd.setCursor(0, 0);
				lcd.print("Set New Password");
				lcd.setCursor(0, 1);
				lcd.print(">");
				while (passChangeMode)
				{
					keypressed = myKeypad.getKey();
					if (keypressed != NO_KEY)
					{
						if (keypressed == '0' || keypressed == '1' || keypressed == '2' || keypressed == '3' ||
										keypressed == '4' || keypressed == '5' || keypressed == '6' || keypressed == '7' ||
										keypressed == '8' || keypressed == '9')
						{
							tempPassword += keypressed;
							lcd.setCursor(i, 1);
							lcd.print("*");
							i++;
							tone(buzzer, 2000, 100);
						}
					}
					if (i > 5 || keypressed == '#')
					{
						tempPassword = "";
						i = 1;
						tone(buzzer, 2000, 100);
						lcd.clear();
						lcd.setCursor(0, 0);
						lcd.print("Set New Password");
						lcd.setCursor(0, 1);
						lcd.print(">");
					}
					if (keypressed == '*')
					{
						i = 1;
						tone(buzzer, 2000, 100);
						password = tempPassword;
						passChangeMode = false;
						passChanged = false;
						screenOffMsg = 0;
					}
				}
			}
		}
 }
}

void inputPass()
{
 for (int i = 0; i < 3; i++)
 {
		lcd.clear();
		lcd.setCursor(0, 0);
		lcd.print(" *** ALARM *** ");
		lcd.setCursor(0, 1);
		lcd.print("Pass>");
		keypressed = myKeypad.getKey();
		if (keypressed != NO_KEY)
		{
			if (keypressed == '0' || keypressed == '1' || keypressed == '2' || keypressed == '3' ||
							keypressed == '4' || keypressed == '5' || keypressed == '6' || keypressed == '7' ||
							keypressed == '8' || keypressed == '9')
			{
				tempPassword += keypressed;
				lcd.setCursor(k, 1);
				lcd.print("*");
				k++;
			}
		}
		if (k > 9 || keypressed == '#')
		{
			tempPassword = "";
			k = 5;
			lcd.clear();
			lcd.setCursor(0, 0);
			lcd.print(" *** ALARM *** ");
			lcd.setCursor(0, 1);
			lcd.print("Pass>");
		}
		if (keypressed == '*')
		{
			if (tempPassword == password)
			{
				// activated = false;
				// alarmActivated = false;
				// noTone(buzzer);
				// screenOffMsg = 0;
				passTrue = true;
				return;
			}
			else if (tempPassword != password)
			{
				passTrue = false;
				lcd.clear();
				lcd.setCursor(0, 1);
				lcd.print("Wrong! Try Again");
				delay(2000);
				// lcd.setCursor(0, 0);
				// lcd.print(" *** ALARM *** ");
				// lcd.setCursor(0, 1);
				// lcd.print("Pass>");
			}
		}
 }
}
void beginLock()
{
 lcd.clear();
 lcd.setCursor(0, 0);
 lcd.print("Alarm will be");
 lcd.setCursor(0, 1);
 lcd.print("activated in");
 for (int i = 3; > 0; --)
 {
		lcd.print(i);
		tone(buzzer, 700, 100);
		delay(1000);
 }
 lcd.clear();
 lcd.setCursor(0, 0);
 lcd.print("Alarm Activated!");
}